<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatterBox</title>
    <link rel="stylesheet" href="/styles/style.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Satisfy&family=VT323&display=swap"
      rel="stylesheet"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Carter+One&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="top_baar">
      <img src="/images/chat-logo.jpg" alt="" />
      <h2>ChatterBox</h2>
    </div>
    <div id="main">
      <div class="box_menu">
        <div class="top_icon">
          <i class="ri-menu-line"></i>
          <i class="ri-chat-1-line"></i>
          <i class="ri-phone-line"></i>
          <div class="line"></div>
          <img
            src="https://img.icons8.com/?size=100&id=99868&format=png&color=FFFFFF"
            alt=""
          />
        </div>

        <div class="bottom_icon">
          <i class="ri-star-line"></i>
          <i class="ri-archive-line"></i>
          <div class="line"></div>
          <i class="ri-settings-2-line"></i>
          <i class="ri-profile-line"></i>
        </div>
      </div>

      <div id="box_left">
        <div class="box_left_top">
          <div class="box1">
            <div class="box1_left">
              <h2>Chat</h2>
            </div>

            <div class="icon">
              <i class="ri-chat-new-line"></i>
              <i class="ri-filter-3-line"></i>
            </div>
          </div>
          <div class="box2">
            <i class="ri-search-line"></i>
            <input
              type="search"
              name="q"
              placeholder="Search or start a new chat..."
              required
            />
          </div>
        </div>

        <form id="card_box" action="">
          <div class="card" id="card1">
            <div class="card_profile">
              <% if (user.profileImage && user.profileImage.data) { %>
              <!-- Show uploaded image from MongoDB -->
              <img
                src="data:<%= user.profileImage.contentType %>;base64,<%= user.profileImage.data.toString('base64') %>"
                alt="<%= user.username %>â€™s avatar"
                class="rounded-full w-12 h-12 object-cover"
              />
              <% } else if (user.profile) { %>
              <!-- Show image from Google login -->
              <img
                src="<%= user.profile %>"
                alt="<%= user.username %>"
                class="rounded-full w-12 h-12 object-cover"
              />
              <% } else { %>
              <!-- Show default image -->
              <img
                src="/images/default-avatar.png"
                alt="Default avatar"
                class="rounded-full w-12 h-12 object-cover"
              />
              <% } %>

              <h5><%= user.displayName || user.username %></h5>
            </div>
          </div>
        </form>
      </div>
      <div id="box_right">
        <div class="box_right_top">
          <!--   click event -->
          <div class="profile">
            <script>
              document
                .getElementById("card1")
                .addEventListener("click", function () {
                  const profileHTML = `
                  <div class="profile"> 
                    <div id="profile-left">
                      <% if (user.profileImage && user.profileImage.data) { %>
                        <img
                          src="data:<%= user.profileImage.contentType %>;base64,<%= user.profileImage.data.toString('base64') %>"
                          alt="Profile Image"
                        />
                      <% } else if (user.profile) { %>
                        <img
                          src="<%= user.profile %>"
                          alt="Google Profile Image"
                        // />
                      <% } else { %>
                        <img
                          src="/images/default-avatar.png"
                          alt="Default Profile Image"
                        />
                      <% } %>
                      <h3><%= user.displayName || user.username %></h3>
                    </div>
                    <div id="profile-right">
                      <i class="ri-video-on-line"></i>
                      <i class="ri-phone-line"></i>
                      <i class="ri-search-line"></i>
                    </div>
                  </div>
                `;
                  document.querySelector(".box_right_top").innerHTML =
                    profileHTML;
                });
            </script>
          </div>
        </div>

        <div class="message_left_baar "></div>
        <div class="box_right_buttom">
          <!--    file send & emoji & payment integration -->
          <div class="buttom_box">
            <i class="ri-emoji-sticker-line"></i>
            <i class="ri-attachment-line"></i>
          </div>
          <!-- send message thru websocket -->
          <div class="type_message">
            <input type="text" placeholder="send message..." name="text" id="messageInput" />
            <div class="send_sms">
              <i id="sendIcon" class="ri-send-plane-fill"></i>
            </div>
            
          </div>
      
          <script
            src="https://cdn.socket.io/4.8.1/socket.io.min.js"
            integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
            crossorigin="anonymous"
          ></script>
        
      
      
      
      
          <script>
            let socket = io();
            const sendIcon = document.querySelector("#sendIcon");
            const messageInput = document.querySelector("#messageInput");
            const allMessage = document.querySelector(".message_left_baar")
      
            function getCurrentTime() {
              const now = new Date();
              return now.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });
            }
      
            // Show messages from others (left)
            socket.on("sendMsg-EveryUser", (data) => {
              if (data.senderId !== socket.id) {
                const p = document.createElement("p");
                p.innerHTML = `${data.message} <span class="timestamp">${getCurrentTime()}</span>`; // set time on message
                p.classList.add("message", "left");
                allMessage.appendChild(p);
                p.style.fontSize="small"
              }
            });
      
            // Send message (right)
            sendIcon.addEventListener("click", () => {
              const message = messageInput.value.trim();
              if (!message) return;
      
              const p = document.createElement("p");
              p.innerHTML = `${message} <span class="timestamp">${getCurrentTime()}</span>`; // set time on message
              p.classList.add("message", "right");
              allMessage.appendChild(p);
      
              socket.emit("sendUser-Message", {
                message,
                senderId: socket.id,
              });
      
              messageInput.value = "";
            });
      
            // Emit typing when user types
            messageInput.addEventListener("input", () => {
              socket.emit("typing");
            });
      
            // When another user is typing
            socket.on("typing", () => {
              // Only change placeholder if this user is not currently typing
              if (document.activeElement !== messageInput) {
                messageInput.placeholder = "User is typing...";
      
                clearTimeout(window.typingReset); // Clear existing timeout
                window.typingReset = setTimeout(() => {
                  messageInput.placeholder = "Send msg";
                }, 2000); // Reset after 2 seconds
              }
            });
          </script>
































          <div class="buttom_box1">
            <a id="pay" href="/pay/create/orderId" target="_blank">
              <i class="ri-money-rupee-circle-line"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
